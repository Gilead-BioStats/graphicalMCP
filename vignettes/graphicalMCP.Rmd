---
title: "Get started"
output: rmarkdown::html_vignette
bibliography: "`r system.file('references.bib', package='graphicalMCP')`"
nocite: |
  @bretz-2009-graphical, @bretz-2011-test, @bretz-2011-graphical
vignette: >
  %\VignetteIndexEntry{Get started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  results = "hide",
  collapse = TRUE,
  comment = "#>",
  fig.align = "center"
)
```

# Introduction

Graphical approaches for multiple comparison procedures (MCPs) are a general framework to control the familywise error rate strongly as a pre-specified significance level $0<\alpha<1$. This approach includes many commonly used MCPs as special cases and is transparent in visualizing MCPs for better communications. `graphicalMCP` is designed to design and analyze graphical MCPs in a flexible, informative and efficient way.

# Installation

`graphicalMCP` is current not on CRAN but can be installed from GitHub using the follow code:

```{r eval = FALSE}
# install.packages("pak")
pak::pak("Gilead-BioStats/graphicalMCP@dev")
```

# Graphs

## Initial graph

The base object in `graphicalMCP` is an `initial_graph`, which consists of a vector of hypothesis weights and a matrix of transition weights [@bretz-2009-graphical]. In the graphical representation, hypotheses are denoted as nodes (or vertices) associated with hypothesis weights. A directed edge from a hypothesis to another indicates the direction of propagation of the hypothesis weight from the origin hypothesis to the end hypothesis. The edge is weighted by a transition weight indicating the proportion of propagation.

```{r create-graph, fig.dim=c(3, 3)}
library(graphicalMCP)
# A graph of two primary hypotheses (H1 and H2) and two secondary hypotheses (H3 and H4)
hypotheses <- c(0.5, 0.5, 0, 0)
transitions <- rbind(
  c(0, 0, 1, 0),
  c(0, 0, 0, 1),
  c(0, 1, 0, 0),
  c(1, 0, 0, 0)
)
hyp_names <- c("H1", "H2", "H3", "H4")
example_graph <- graph_create(hypotheses, transitions, hyp_names)
example_graph
```

```{r plot-graph, fig.dim=c(3, 3)}
plot(example_graph, vertex.size = 60)
```

## Update graph

When a hypothesis is removed from the graph, hypothesis and transition weights of remaining hypotheses should be updated according to Algorithm 1 in @bretz-2011-tests. For example, assume that hypotheses H1, H2 and H4 are removed from the graph. The updated graph after removing three hypotheses is below.

```{r update-graph}
updated_example <- graph_update(example_graph,
                                delete = c(TRUE, TRUE, FALSE, TRUE))

updated_example
```

```{r plot-updated-graph, fig.dim=c(3, 3)}
plot(updated_example, vertex.size = 60)
```

# Perform graphical MCPs

Given the set of p-values of all hypotheses, graphical MCPs can be performed using `graph_test_shortcut()` to determine which hypotheses can be rejected at the significance level `alpha`. Assume p-values are 0.01, 0.005, 0.03, and 0.01 for hypotheses H1-H4. With a one-sided significance level `alpha = 0.025`, rejected hypotheses are H1, H2, and H4. More details about the shortcut testing can be found in `vignette("shortcut-testing")`.

```{r test-graph-shortcut}
test_results <- graph_test_shortcut(
  example_graph,
  p = c(.01, .005, .03, .01),
  alpha = .025)
test_results$outputs$rejected
```

A similar testing procedure can be performed using the closure principle. This will allow more tests for intersection hypotheses, e.g., Simes, parametric and a mixture of them. If the test type is Bonferroni, the resulting closed procedure is equivalent to the shortcut procedure above. Additional details about closed testing can be found in `vignette("closed-testing")`.

```{r test-graph}
test_results_closed <- graph_test_closure(
  example_graph,
  p = c(.01, .005, .03, .01),
  alpha = .025,
  test_types = "bonferroni",
  test_groups = list(1:4)
)
test_results_closed$outputs$rejected
```

# Power simulations

With multiplicity adjustment, such as graphical MCPs, the "power" to reject each hypothesis will be affected, compared to its marginal power. The latter is the power to rejected a hypothesis at the significance level `alpha` without multiplicity adjustment. The marginal power is usually obtained from other pieces of statistical software. `graph_calculate_power` performs power simulations to assess the power after adjusting for the graphical MCP. Assume that the marginal power to reject H1-H4 is 90%, 90%, 80%, and 80% and all test statistics are independent of each other. The local power after the multiplicity adjustment is 87.7%, 87.7, 67.2%, and 67.2% respectively for H1-H4. Additional details about closed testing can be found in `vignette("shortcut-testing")` and `vignette("closed-testing")`.

```{r power}
set.seed(1234)
power_results <- graph_calculate_power(
  example_graph,
  sim_n = 1e6,
  power_marginal = c(.9, .9, .8, .8)
)
power_results$power$power_local
```

# References

################################################################################

# Glossary of terms {#glossary-of-terms}

This package seeks to be both accurate and performant, of course. But beyond that, much thought has been put into the readability of the code. Whether being read by a user validating our methods, a developer extending the package to new uses, or a contributor helping enhance the core functionality, we hope that the code contained here can serve as an educational document to grow people's understanding of the graphical approach to multiple comparison procedures.

To that end, there are several entities encountered in the world of graphical MCPs that we define here. Some of these are used only in the internal code of the package, but most are inputs or output in one or more exported functions. If you believe any definitions could be clarified or improved, please contact the package authors or submit an issue to the GitHub repository.

+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+
| Entity                          | Definition                                                                                                                                                                                                         | Aliases                               | Variable(s)                     | Related                         |
+=================================+====================================================================================================================================================================================================================+=======================================+=================================+=================================+
| **Graph**                       | A set of nodes and edges representing a clinical trial design                                                                                                                                                      |                                       | `graph`                         | Hypotheses, Transitions         |
+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+
|                                 | **Graphs** are so central that two of their core qualities get their own common variable names: Hypothesis names, and number of hypotheses                                                                         |                                       | `hyp_names`, `num_hyps`         |                                 |
+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+
| **Hypotheses**                  | The weighted nodes in a **graph**. Each node represents a null hypothesis corresponding to a treatment endpoint, and its weight the local significance level.                                                      | weights, hypothesis weights           | `hypotheses`                    | Weighting strategy, Transitions |
+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+
| **Transitions**                 | The weighted edges in a **graph**. Each edge defines how to propagate local significance when a source node is deleted.                                                                                            |                                       | `transitions`                   | Hypotheses                      |
+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+
| **Intersection** **hypothesis** | A subset of **hypotheses** from a **graph**. Plural often implies all such subsets.                                                                                                                                | intersection, sub-graph(s), closure   | `intersections`                 | Weighting strategy              |
+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+
| **Weighting strategy**          | The set of all **intersections** and their **weights** according to Algorithm 1 in Bretz et al (2011)                                                                                                              | intersection weights, closure weights | `weighting_strategy`            |                                 |
+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+
| **Adjusted weights**            | The set of **weights**, adjusted according to a testing algorithm:                                                                                                                                                 |                                       | `adjusted_weights`              |                                 |
|                                 |                                                                                                                                                                                                                    |                                       |                                 |                                 |
|                                 | -   Bonferroni: No change                                                                                                                                                                                          |                                       |                                 |                                 |
|                                 | -   Simes: Sum weights for hypotheses with smaller p-values                                                                                                                                                        |                                       |                                 |                                 |
|                                 | -   Parametric: Multiply weights by c-value, based on the joint distribution                                                                                                                                       |                                       |                                 |                                 |
+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+
| **P-values**                    | The set of p-values from a real or simulated clinical trial                                                                                                                                                        |                                       | `p`                             | Adjusted & ordered p-values     |
+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+
| **Ordered p-values**            | **P-values** sorted from smallest to largest                                                                                                                                                                       |                                       | `ordered_p`                     | (Adjusted) P-values             |
+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+
| **Adjusted p-values**           | **P-values** that have been divided by **adjusted weights**, allowing direct comparison to **alpha** to determine significance                                                                                     |                                       | `adjusted_p`                    | (Ordered) P-values              |
+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+
| **Significance level**          | The threshold chosen for results of a clinical trial to be considered significant                                                                                                                                  |                                       | `alpha`                         | P-values                        |
+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+
| **Test types**                  | A specification of which testing algorithm to use - Bonferroni, Simes, and parametric are supported                                                                                                                | tests                                 | `test_types`                    | Testing strategy                |
+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+
| **Test groups**                 | A partition of nodes in a **graph** specifying which **hypotheses** should be tested together                                                                                                                      | groups                                | `groups`, `test_groups`         | Testing strategy                |
+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+
| **Testing strategy**            | **Test types** and **test groups** combined                                                                                                                                                                        |                                       |                                 |                                 |
+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+
| **Marginal power**              | The power to reject each null **hypothesis** at full **alpha**. Closely related to the non-centrality parameter, which is the mean of each null **hypothesis** in the underlying multivariate normal distribution: |                                       | `marginal_power`                | Correlation matrix              |
|                                 |                                                                                                                                                                                                                    |                                       |                                 |                                 |
|                                 | `ncp = qnorm(1 - alpha) - qnorm(1 - marginal_power)`                                                                                                                                                               |                                       |                                 |                                 |
+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+
| **Correlation matrix**          | Specification of correlations between **hypotheses**. Together with **marginal power**, this specifies the (known or assumed) underlying multivariate normal distribution of the null **hypotheses**.              |                                       | `corr`, `test_corr`, `sim_corr` | Marginal power                  |
+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+
| **Success**                     | A specification of which null **hypotheses** must be rejected to consider a clinical trial a success                                                                                                               |                                       | `sim_success`                   |                                 |
+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+
| **Power**                       | Under a given **graph**, **testing strategy**, **significance level**, and underlying distribution, the estimated likelihood that a particular combination of null hypotheses will be rejected                     |                                       | `power_*`                       | Success                         |
+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+
| *Delete a **hypothesis***       | Remove a **hypothesis** from a graph, and update the graph according to algorithm 1 of Bretz et al. (2011)                                                                                                         |                                       | N/A                             | Reject a hypothesis             |
+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+
| *Reject a **hypothesis***       | Under a given **graph**, **testing strategy**, and **significance level**, find a hypothesis (clinical endpoint) to be statistically significant, such that the null hypothesis can be rejected                    |                                       |                                 | Delete a hypothesis             |
+---------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------+---------------------------------+---------------------------------+

