---
title: "case-study"
output:
  rmarkdown::html_vignette:
    code_folding: "hide"
vignette: >
  %\VignetteIndexEntry{case-study}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(graphicalMCP)
```

This vignette serves to demonstrate testing and power calculations for a moderately complex graph example. The graph we'll create has a Bonferroni Holm structure between two groups, each of which have a parallel gate-keeping structure with one primary hypothesis and two secondary hypotheses.

### Initial graph

```{r initial-graph}
eps <- .0001

hypotheses <- c(rep(c(1 / 2, 0, 0), 2))
transitions <- rbind(
  c(0, .5, .5, 0, 0, 0),
  c(0, 0, 1, 0, 0, 0),
  c(0, 1 - eps, 0, eps, 0, 0),
  c(0, 0, 0, 0, .5, .5),
  c(0, 0, 0, 0, 0, 1),
  c(eps, 0, 0, 0, 1 - eps, 0)
)

g_complex <- create_graph(hypotheses, transitions)

print(g_complex)
```

In this example, study data has been simulated to demonstrate the calculation of marginal power for the power simulation. Let's say the study is looking at a new diabetes medication. The study uses two dose levels against a placebo, corresponding to the two hypothesis groups. Each dose level is tested for A1C (primary endpoint), as well as time in range and retinopathy progression (secondary endpoints). Study sample size is 600, with participants spread equally across each dose level and placebo.

```{r study-results}
alpha <- .025

cohort_size <- 200

means <- c(.7, .1, 0, .6, .25, .7)
sds <- c(1, 2, .1, 3, 1, .5)

# simulate performance of each endpoint against placebo
study_results <- mapply(rnorm, rep(cohort_size, 6), means, sds)

t_tests <- apply(study_results, 2, t.test, alternative = "greater")
t_test_means <- lapply(t_tests, getElement, "estimate")
t_test_pvals <- vapply(t_tests, getElement, numeric(1), "p.value")

marginal_power <- vapply(
  t_test_means,
  function(sample_mean) qnorm(alpha, sample_mean, lower.tail = FALSE),
  numeric(1)
)
```

The two primary hypotheses will be tested as a parametric group. Correlation between doses at the same endpoint reduces to 0.5 with equal randomization. Correlation between endpoints within a dose group is unknown; we'll assume 0.4. Correlations between one endpoint in one dose group and another endpoint in another dose group can be calculated with the product rule. This results in the correlation matrix below. Testing and power will be calculated at the global level 0.025.

```{r test}
rho_com_endpoint <- 0.4
rho_com_dose <- 0.5
rho_no_com <- rho_com_endpoint * rho_com_dose

t_corr <- rbind(
  c(1, rho_com_dose, rho_com_dose, rho_com_endpoint, rho_no_com, rho_no_com),
  c(rho_com_dose, 1, rho_com_dose, rho_no_com, rho_com_endpoint, rho_no_com),
  c(rho_com_dose, rho_com_dose, 1, rho_no_com, rho_no_com, rho_com_endpoint),
  c(rho_com_endpoint, rho_no_com, rho_no_com, 1, rho_com_dose, rho_com_dose),
  c(rho_no_com, rho_com_endpoint, rho_no_com, rho_com_dose, 1, rho_com_dose),
  c(rho_no_com, rho_no_com, rho_com_endpoint, rho_com_dose, rho_com_dose, 1)
)

test_graph(
  g_complex,
  t_test_pvals,
  alpha = .025,
  groups = list(c(1, 4), 2:3, 5:6),
  test_types = c("p", "s", "s"),
  corr = t_corr
)
```

It's not always obvious from a graph how easy or difficult it will be to reject each hypothesis. One way to understand this better is to run a power simulation. The essence of a power simulation is to generate many different p-values using some chosen distribution, then test the graph against each set of p-values to see how it performs.

The p-values are sampled from a multivariate normal distribution using a one-sided test. The means of the MVN should be set as the marginal power of each hypothesis, and `sim_corr` should be the correlation between hypotheses that is induced by the study design.

```{r power}
calculate_power(
  g_complex,
  alpha = alpha,
  test_groups = list(c(1, 4), 2:3, 5:6),
  test_types = c("p", "s", "s"),
  test_corr = t_corr,
  sim_n = 1e5,
  marginal_power = marginal_power,
  sim_success = c(1, 4)
)
```
