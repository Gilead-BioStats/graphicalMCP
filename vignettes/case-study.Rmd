---
title: "case-study"
output:
  rmarkdown::html_vignette:
    code_folding: "show"
vignette: >
  %\VignetteIndexEntry{case-study}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(graphicalMCP)
```

## Initial graph

This vignette serves to demonstrate testing and power calculations for a moderately complex graph example. We'll follow a hypothetical study for a new diabetes treatment at two dose levels. Each dose level is tested at three endpoints - Mean change in A1C level against placebo as the primary endpoint, and mean time-in-range and retinopathy progression against placebo as the secondary endpoints. Study sample size is 600, with participants spread equally across each dose level and placebo.

The initial weight should be split between the primary hypotheses, and each secondary hypothesis should only be tested if the corresponding primary hypothesis can be rejected. Weight from one dose group should certainly be passed to the other dose group if all of one dose is rejected. But scenarios will be explored where some weight is passed directly between primary hypotheses as well.

These requirements result in the graph below. The value `gamma` can be set to control how much weight is passed between primary hypotheses vs how much is passed to the secondary groups.

```{r initial-graph}
complex_gamma <- function(gamma) {
  eps <- .0001

  hypotheses <- c(rep(c(1 / 2, 0, 0), 2))
  transitions <- rbind(
    c(0, (1 - gamma) / 2, (1 - gamma) / 2, gamma, 0, 0),
    c(0, 0, 1, 0, 0, 0),
    c(0, 1 - eps, 0, eps, 0, 0),
    c(gamma, 0, 0, 0, (1 - gamma) / 2, (1 - gamma) / 2),
    c(0, 0, 0, 0, 0, 1),
    c(eps, 0, 0, 0, 1 - eps, 0)
  )

  create_graph(hypotheses, transitions)
}

g_complex <- complex_gamma(.5)

print(g_complex)
```

## Test design {#test-design}

In this section we'll lay out some possible testing strategies. These testing strategies cannot be run until p-values are calculated from study data. See [Test Execution] below

### Bonferroni {#test-design-bonferroni}

The study results could be tested most simply with a Bonferroni testing method.

```{r bonferroni, eval=FALSE}
test_graph(g_complex, calculated_p_values, alpha = .025)
```

### Parametric-Bonferroni {#test-design-parametric-bonferroni}

But we can take advantage of the correlation between doses by testing the primary hypotheses together in a parametric group. Correlation between doses at the same endpoint reduces to 0.5 with equal randomization. For parametric testing, the only correlations that need to be specified are between hypotheses in a parametric group

```{r test-corr}
rho_com_endpoint <- 0.5

t_corr <- rbind(
  c(1, NA, NA, rho_com_endpoint, NA, NA),
  c(NA, 1, NA, NA, rho_com_endpoint, NA),
  c(NA, NA, 1, NA, NA, rho_com_endpoint),
  c(rho_com_endpoint, NA, NA, 1, NA, NA),
  c(NA, rho_com_endpoint, NA, NA, 1, NA),
  c(NA, NA, rho_com_endpoint, NA, NA, 1)
)
```

```{r para-bonf, eval=FALSE}
test_graph(
  g_complex,
  calculated_p_values,
  alpha = .025,
  groups = list(c(1, 4), c(2, 3, 5, 6)),
  test_types = c("p", "b"),
  corr = t_corr
)
```

### Parametric-Simes {#test-design-parametric-simes}

Even beyond that, it may make sense to test each pair of secondary hypotheses as a Simes group. This may add a small amount of power, depending on what gamma value is chosen.

```{r para-simes, eval=FALSE}
test_graph(
  g_complex,
  calculated_p_values,
  alpha = .025,
  groups = list(c(1, 4), 2:3, 5:6),
  test_types = c("p", "s", "s"),
  corr = t_corr
)
```

These test designs are explored further in [Test execution] below.

## Power calculations {#power-calculations}

It's not always obvious from an initial graph how easy or difficult it will be to reject each hypothesis. One way to understand this better is to run a power simulation. The essence of a power simulation is to generate many different p-values using an assumed distribution, then test the graph against each set of p-values to see how it performs. In most cases, power will be calculated under many different scenarios to better understand the testing space.

The p-values for a power simulation are sampled from a multivariate normal distribution using a one-sided test. The means of the MVN should be set as the marginal power of each hypothesis, and the correlations should be the correlation between hypotheses that are either known from the study design or assumed.

[Talk about how marginal power is calculated, and where the correlation comes from. Is it different from `test_corr`?]

```{r power, eval=FALSE}
calculate_power(
  g_complex,
  alpha = alpha,
  test_groups = list(c(1, 4), 2:3, 5:6),
  test_types = c("p", "s", "s"),
  test_corr = t_corr,
  sim_n = 1e5,
  marginal_power = marginal_power, # this needs to be calculated
  sim_success = c(1, 4),
  sim_seed = 6723
)
```

## Study data {#study-data}

```{r study-results}
alpha <- .025

cohort_size <- 200

means <- c(.7, .1, 0, .6, .25, .7)
sds <- c(1, 2, .1, 3, 1, .5)

# simulate performance of each endpoint against placebo
study_results <- mapply(rnorm, rep(cohort_size, 6), means, sds)

t_tests <- apply(study_results, 2, t.test, alternative = "greater")
t_test_means <- lapply(t_tests, getElement, "estimate")
t_test_pvals <- vapply(t_tests, getElement, numeric(1), "p.value")

marginal_power <- vapply(
  t_test_means,
  function(sample_mean) qnorm(alpha, sample_mean, lower.tail = FALSE),
  numeric(1)
)
```

## Test execution {#test-execution}

The study results could be tested most simply with a Bonferroni testing method.

But we can take advantage of the correlation between doses by testing the primary hypotheses together in a parametric group. Correlation between doses at the same endpoint reduces to 0.5 with equal randomization. We can demonstrate more functionality for the package by combining each dose's secondary endpoints together in a Simes group.

~~Correlation between endpoints within a dose group is unknown; we'll assume 0.4. Correlations between one endpoint in one dose group and another endpoint in another dose group can be calculated with the product rule. This results in the correlation matrix below. Testing and power will be calculated at the global level 0.025.~~
